name: Build Desktop App

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:  # Allow manual triggering

env:
  APP_NAME: WhisperNow
  # Version is set from git tag for releases, fallback to 0.1.0 for dev builds
  APP_VERSION: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '0.1.0' }}

jobs:
  # ============================================================================
  # Windows Build - Creates .exe installer using Inno Setup
  # ============================================================================
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      
    - name: Install Dependencies
      run: uv sync --group dev
        
    - name: Run PyInstaller
      run: |
        uv run python scripts/build.py
        
    - name: Debug - Show build size
      run: |
        echo "=== PyInstaller output ==="
        Get-ChildItem -Recurse dist | Measure-Object -Property Length -Sum
        Get-ChildItem dist/whispernow -Recurse | Sort-Object Length -Descending | Select-Object -First 20

    - name: Create Installer with Inno Setup
      run: iscc /O+ installer.iss
      shell: cmd
        
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Windows-Setup
        path: installer-output/*.exe
        if-no-files-found: error

  # ============================================================================
  # macOS Build - Creates .app bundle and .dmg disk image
  # ============================================================================
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      
    - name: Install Dependencies
      run: uv sync --group dev
        
    - name: Run PyInstaller
      run: |
        uv run python scripts/build.py

    - name: Debug - Show build size
      run: |
        echo "=== PyInstaller output ==="
        du -sh dist/
        du -h dist/WhisperNow.app/Contents/MacOS/ | sort -h | tail -20
      
    - name: Install create-dmg
      run: brew install create-dmg

    - name: Create DMG
      run: |
        # First, verify the .app bundle exists
        if [ ! -d "dist/WhisperNow.app" ]; then
          echo "Error: dist/WhisperNow.app not found!"
          ls -la dist/
          exit 1
        fi
        
        # Try styled DMG first, fall back to simple hdiutil if it fails
        create-dmg \
          --volname "${{ env.APP_NAME }}" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "${{ env.APP_NAME }}.app" 175 190 \
          --hide-extension "${{ env.APP_NAME }}.app" \
          --app-drop-link 425 190 \
          "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-macOS.dmg" \
          "dist/WhisperNow.app" || \
        hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder "dist/WhisperNow.app" -ov -format UDZO "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-macOS.dmg"
        
    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-macOS-DMG
        path: "*.dmg"
        if-no-files-found: error

  # ============================================================================
  # Linux Build - Creates AppImage
  # ============================================================================
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        # Remove large unused software to free up ~30GB
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        df -h
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        # libfuse2 is required for AppImage (uses fuse2, not fuse3)
        sudo apt-get install -y libfuse2
      
    - name: Install Dependencies
      run: uv sync --group dev
        
    - name: Build with PyInstaller
      run: |
        uv run python scripts/build.py
        
    - name: Debug - Show build size
      run: |
        echo "=== PyInstaller output ==="
        du -sh dist/
        du -h dist/whispernow/ | sort -h | tail -20

    - name: Create AppImage structure
      run: |
        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy built application
        cp -r dist/whispernow/* AppDir/usr/bin/
        
        # Create desktop entry
        cat > AppDir/usr/share/applications/whispernow.desktop << 'EOF'
        [Desktop Entry]
        Name=WhisperNow
        Exec=whispernow
        Icon=whispernow
        Type=Application
        Categories=Utility;Audio;
        Comment=Push-to-talk speech transcription
        EOF
        
        # Also place desktop file at root (required by AppImage)
        cp AppDir/usr/share/applications/whispernow.desktop AppDir/
        
        # Create a simple icon placeholder (would be replaced with real icon)
        # Using a 1x1 transparent PNG as placeholder
        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > AppDir/usr/share/icons/hicolor/256x256/apps/whispernow.png
        cp AppDir/usr/share/icons/hicolor/256x256/apps/whispernow.png AppDir/whispernow.png
        
        # Create AppRun script
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/bin:${LD_LIBRARY_PATH}"
        exec "${HERE}/usr/bin/whispernow" "$@"
        EOF
        chmod +x AppDir/AppRun
        
    - name: Download appimagetool
      run: |
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
    - name: Create AppImage
      run: |
        ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-Linux.AppImage
        
    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Linux-AppImage
        path: "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-Linux.AppImage"
        if-no-files-found: error

  # ============================================================================
  # Release - Create GitHub Release when a version tag is pushed
  # ============================================================================
  release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Prepare release files
      run: |
        mkdir release-files
        # Find and copy all installer files
        find artifacts -name "*.exe" -exec cp {} release-files/ \;
        find artifacts -name "*.dmg" -exec cp {} release-files/ \;
        find artifacts -name "*.AppImage" -exec cp {} release-files/ \;
        ls -la release-files/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: release-files/*
        draft: true  # Create as draft so you can review before publishing
