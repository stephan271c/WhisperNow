name: Build Desktop App

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:  # Allow manual triggering

env:
  APP_NAME: WhisperNow
  # Version is set from git tag for releases, fallback to 0.1.0 for dev builds
  APP_VERSION: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '0.1.0' }}

jobs:
  # ============================================================================
  # Test - Run tests before building
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Restore uv cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-
      
    - name: Install system dependencies for Qt
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libegl-dev libxkbcommon0 libxcb-xinerama0 libxcb-cursor0 libportaudio2

    - name: Install Dependencies
      run: uv sync --group dev
        
    - name: Run Tests
      env:
        QT_QPA_PLATFORM: offscreen
        PYNPUT_BACKEND: dummy
      run: uv run pytest -v

  # ============================================================================
  # Windows Build - Creates .exe installer using Inno Setup
  # ============================================================================
  build-windows:
    name: Build Windows Installer
    needs: test
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Restore uv cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-
      
    - name: Install Dependencies
      run: uv sync --group dev
        
    - name: Build with Briefcase
      run: |
        uv run python scripts/build.py
        
    - name: Debug - Show build output
      run: |
        echo "=== Briefcase output ==="
        Get-ChildItem -Recurse build/whispernow/windows/app -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum
        Get-ChildItem build/whispernow/windows/app -Recurse -ErrorAction SilentlyContinue | Sort-Object Length -Descending | Select-Object -First 20

    - name: Create Installer with Inno Setup
      run: iscc /O+ installer.iss
      shell: cmd
        
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Windows-Setup
        path: installer-output/*.exe
        if-no-files-found: error

  # ============================================================================
  # Linux Build - Creates AppImage using Briefcase
  # ============================================================================
  build-linux:
    name: Build Linux AppImage
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        # Remove large unused software to free up ~30GB
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        df -h
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Restore uv cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        # libfuse2 is required for AppImage
        sudo apt-get install -y libfuse2
      
    - name: Install Dependencies
      run: uv sync --group dev
        
    - name: Build with Briefcase
      run: |
        uv run python scripts/build.py
        
    - name: Debug - Show build output
      run: |
        echo "=== Briefcase output ==="
        du -sh build/whispernow/linux/appimage/ || true
        ls -la build/whispernow/linux/appimage/ || true
        find build -name "*.AppImage" 2>/dev/null || true

    - name: Package AppImage
      run: |
        uv run briefcase package linux appimage
        
    - name: Find and rename AppImage
      run: |
        # Find the generated AppImage
        APPIMAGE=$(find build -name "*.AppImage" -type f | head -1)
        if [ -z "$APPIMAGE" ]; then
          echo "Error: No AppImage found!"
          find build -type f -name "*" | head -50
          exit 1
        fi
        echo "Found AppImage: $APPIMAGE"
        cp "$APPIMAGE" "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-Linux.AppImage"
        
    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Linux-AppImage
        path: "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-Linux.AppImage"
        if-no-files-found: error

  # ============================================================================
  # Release - Create GitHub Release when a version tag is pushed
  # ============================================================================
  release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Prepare release files
      run: |
        mkdir release-files
        # Find and copy all installer files
        find artifacts -name "*.exe" -exec cp {} release-files/ \;
        find artifacts -name "*.AppImage" -exec cp {} release-files/ \;
        ls -la release-files/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: release-files/*
        draft: true  # Create as draft so you can review before publishing
